<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OctoCash</title>

  <!-- Ic√¥ne et manifest -->
  <link rel="icon" type="image/png" href="https://i.postimg.cc/W42shZTD/Chat-GPT-Image-22-sept-2025-19-00-20.png">
<link rel="apple-touch-icon" href="https://i.postimg.cc/W42shZTD/Chat-GPT-Image-22-sept-2025-19-00-20.png">
<meta name="apple-mobile-web-app-title" content="OctoCash">
<meta name="application-name" content="OctoCash">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* === Fond tentacules (gris sombre + or) === */
    :root {
      --bg-url: url('https://i.postimg.cc/fbwbZdVb/Chat-GPT-Image-22-sept-2025-14-08-38.png');
      --gold: #ffd166; /* accent or */
    }

    html, body { height: 100%; }

    body {
      background: #111;
      color: #f1f1f1;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(to bottom, rgba(0,0,0,.3), rgba(0,0,0,.6)),
        var(--bg-url);
      background-size: cover;
      background-position: center top;
      background-repeat: no-repeat;
      z-index: -1;
    }
    @media (max-width: 640px){
      body::before { position: absolute; }
    }
@media (max-width: 420px){
  /* compacter le tableau */
  table.w-full td, table.w-full th { padding: .35rem .4rem; }
  /* r√©duire un poil la taille du total pour √©viter les coupes */
  #totalCaisse { font-size: 1.5rem; } /* avant: text-2xl ~1.5rem, ajuste si besoin */
  /* inputs + select un peu plus √©troits */
  #tbody input[type="number"] { width: 3.5rem; }  /* ~56px */
  #tbody select { width: 1.5rem; padding-left: .25rem; padding-right: .25rem; }
}

    /* Inputs num√©riques -> clavier num√©rique sur mobile et suppression du style bleu */
    input[type=number],
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-color: #0a0a0a !important;
      color: #f1f1f1 !important;
      border: 1px solid #000 !important;
      box-shadow: none !important;
      outline: none;
    }
    /* Supprimer les fl√®ches ‚Üë‚Üì des input number */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    /* Utilitaires */
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sticky-cta { position: sticky; bottom: 0; background: rgba(24,24,24,0.95); padding: .5rem; border-top: 1px solid rgba(120,120,120,.35); backdrop-filter: blur(6px); }

    /* Mise en avant des totaux */
    #totalCaisse { color: var(--gold); text-shadow: 0 0 6px rgba(255,210,80,.25); }
    [data-total] { font-weight: 700; color: var(--gold); }

    /* Tables/cards en gris neutre */
    table thead { background: rgba(75,75,75,.9); }
    table tfoot { background: rgba(45,45,45,.9); }
    .card { background: rgba(32,32,32,.85); border: 1px solid rgba(120,120,120,.45); }

    /* Radios custom or, sans bleu */
    .radio-gold {
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      width: 1.25rem; height: 1.25rem; border-radius: 9999px;
      border: 2px solid #bbb;
      background-color: #333;
      cursor: pointer; position: relative; display: inline-block;
    }
    .radio-gold:checked {
      background-color: #ffd166;
      border-color: #ffd166;
    }

    #fondCancel {
      background-color: #1f1f1f !important;
      color: #e5e5e5 !important;
      border: 1px solid #444 !important;
    }
    #fondCancel:hover { background-color: #333 !important; }

    /* Radios + labels du modal : pas de bleu, style dark+or */
    #fondModal, #fondModal * { -webkit-tap-highlight-color: transparent; }
    #fondModal label { user-select: none; }
    #fondModal label {
      background-color: rgba(0,0,0,.20) !important;
      border-color: #565656 !important;
      transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    #fondModal label:hover {
      background-color: #2b2b2b !important;
      border-color: #6b6b6b !important;
    }
    #fondModal input[type="radio"].radio-gold:focus {
      outline: none !important;
      box-shadow: 0 0 0 2px rgba(255,209,102,.25);
      border-radius: 9999px;
    }
    #fondModal label:has(.radio-gold:checked) {
      background-color: #1f1a12 !important;
      border-color: #b08900 !important;
      box-shadow: 0 0 0 2px rgba(255,209,102,.30);
    }
    #fondModal ::selection { background: rgba(255,209,102,.28); color: #fff; }

    /* Signature */
    .signature {
      margin: 2rem auto 1.5rem;
      display: flex; align-items: center; justify-content: center; gap: .6rem;
      color: #e5e5e5; opacity: .85; font-weight: 600;
    }
    .signature svg { width: 18px; height: 18px; display: inline-block; }

/* Emp√™che le zoom automatique sur iOS quand on clique sur un input */
  input,
  select,
  textarea {
    font-size: 16px !important;
  }
  </style>
</head>
<body class="min-h-screen text-gray-100">
  <div class="max-w-md mx-auto p-4 pb-28">
    <!-- (Titres supprim√©s comme demand√©) -->

    <!-- Tableau de saisie -->
    <section class="mb-4">
      <div class="rounded-2xl shadow-sm overflow-hidden card">
        <table class="w-full text-sm">
          <thead class="text-gray-200">
  <tr>
    <th class="text-center p-2 w-[72px] sm:w-[84px]">Vrac üü°</th>
    <th class="text-left p-2 w-[50px]  sm:w-[58px]">Rouleaux</th>
    <th class="text-center p-2 w-[86px]  sm:w-[100px]">Valeurs ‚Ç¨</th>
    <th class= p-2">Total üí∞</th>
  </tr>
</thead>

          <tbody id="tbody" class="divide-y divide-gray-700"></tbody>
          <tfoot>
  <tr>
    <td colspan="4" class="p-3 text-center">
      <span class="text-lg font-semibold text-gray-200 mr-2">Total caisse :</span>
      <span id="totalCaisse" class="mono font-bold text-yellow-400 text-2xl">
        0,00 ‚Ç¨
      </span>
    </td>
  </tr>
</tfoot>


        </table>
      </div>
    </section>



    <!-- Actions principales -->
    <section class="sticky-cta rounded-2xl">
      <div class="flex items-center gap-2">
        <button id="btnCalculer" class="flex-1 px-4 py-3 rounded-2xl bg-yellow-400 text-black font-semibold shadow hover:bg-yellow-300 active:translate-y-px">Calculer la recette</button>
        <button id="btnReset" class="px-4 py-3 rounded-2xl bg-black text-gray-200 hover:bg-gray-900">R√©initialiser</button>
      </div>
    </section>

    <!-- R√©sultats -->
    <section class="mt-4" id="resultats" hidden>
      <div class="rounded-2xl shadow-sm p-3 card">
        <div class="grid grid-cols-1 gap-3">
          <div class="p-3 rounded-xl bg-gray-800/70 border border-gray-600 text-center">
            <div class="text-sm uppercase tracking-wide text-gray-400">RECETTE √Ä ENVOYER ‚úâÔ∏è</div>
            <div class="text-2xl font-bold mono text-yellow-400" id="valRecette">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="rounded-2xl shadow-sm p-3 mt-3 card">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-yellow-400">D√âTAIL RECETTE :</h4>
          <span class="text-sm text-gray-400">Fond s√©lectionn√© : <strong id="fondActuelBadge" class="text-gray-100">200,00 ‚Ç¨</strong></span>
        </div>
        <div id="detailRecette" class="text-sm space-y-1 text-center"></div>
      </div>
    </section>
  </div>

<!-- Signature -->
<div class="signature text-yellow-300 italic font-light tracking-wide text-base flex items-center justify-center gap-1 mt-6" style="transform: skewX(-10deg);">
  By Edithe üíõ 
    <path d="M12 21s-6.716-4.373-9.33-7.117C.93 11.02 1.238 7.94 3.343 6.02 5.26 4.288 8.093 4.61 10 6.243c1.907-1.633 4.74-1.955 6.657-.223 2.105 1.92 2.413 5 .673 7.863C18.716 16.627 12 21 12 21z"/>
  </svg>
</div>

  <!-- MODAL de s√©lection du fond -->
  <div id="fondModal" class="fixed inset-0 z-50 hidden" aria-labelledby="fondTitle" aria-modal="true" role="dialog">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close="backdrop"></div>
    <div class="relative max-w-md mx-auto mt-24 card rounded-2xl shadow-xl overflow-hidden">
      <div class="p-4 border-b border-gray-700">
        <h3 id="fondTitle" class="text-lg font-semibold text-yellow-400">Choisir le fond de caisse</h3>
        <p class="text-sm text-gray-400">S√©lectionnez un fond √† conserver avant de calculer la recette.</p>
      </div>
      <div class="p-4 space-y-3">
        <!-- Billetterie -->
        <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-700 hover:bg-gray-800 cursor-pointer">
          <input type="radio" name="fondChoice" value="20000" class="radio-gold" />
          <div>
            <div class="font-medium">Fond Billetterie</div>
            <div class="text-lg font-semibold text-yellow-400">200,00 ‚Ç¨</div>
          </div>
        </label>
        <!-- Boutique -->
        <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-700 hover:bg-gray-800 cursor-pointer">
          <input type="radio" name="fondChoice" value="25000" class="radio-gold" />
          <div>
            <div class="font-medium">Fond Boutique</div>
            <div class="text-lg font-semibold text-yellow-400">250,00 ‚Ç¨</div>
          </div>
        </label>
        <!-- Fond personnalis√© (tout le bloc cliquable comme les autres) -->
        <label for="fondCustomRadio" class="flex items-start gap-3 p-3 rounded-xl border border-gray-700 hover:bg-gray-800 cursor-pointer">
          <input type="radio" id="fondCustomRadio" name="fondChoice" value="custom" class="radio-gold mt-1" />
          <div class="flex-1">
            <div class="font-medium">Fond personnalis√©</div>
            <div class="mt-1 flex items-center gap-2">
              <input id="fondCustom" type="number" step="0.01" inputmode="decimal"
                     class="w-32 px-2 py-1 rounded-lg border border-gray-700 bg-gray-800 text-gray-100"
                     placeholder="ex : 150" />
              <span class="text-xs text-gray-400">‚Ç¨</span>
            </div>
          </div>
        </label>
        <p id="fondCustomHint" class="mt-2 text-xs text-rose-400 hidden">Veuillez saisir un montant valide ‚â• 0.</p>
      </div>
      <div class="p-4 border-t border-gray-700 flex items-center justify-end gap-2">
        <button id="fondCancel" class="px-3 py-2 rounded-xl">Annuler</button>
        <button id="fondConfirm" class="px-4 py-2 rounded-xl bg-yellow-400 text-black font-semibold hover:bg-yellow-300">Confirmer</button>
      </div>
    </div>
  </div>

  <script>
    // --- Mod√®le des d√©nominations (centimes) ---
    const EURO = {
  coins: [
    { value: 1,   label: '<span class="whitespace-nowrap"><span class="text-[10px]">üü§</span><span class="ml-1 text-[13px] font-medium align-middle">1 c</span></span>', roll: 50 },
    { value: 2,   label: '<span class="whitespace-nowrap"><span class="text-[11px]">üü§</span><span class="ml-1 text-[13px] font-medium align-middle">2 c</span></span>', roll: 50 },
    { value: 5,   label: '<span class="whitespace-nowrap"><span class="text-xs">üü§</span><span class="ml-1 text-[13px] font-medium align-middle">5 c</span></span>', roll: 50 },
    { value: 10,  label: '<span class="whitespace-nowrap"><span class="mr-1 text-sm">üü°</span><span class="text-[13px] font-medium align-middle">10 c</span></span>', roll: 40 },
    { value: 20,  label: '<span class="whitespace-nowrap"><span class="mr-1 text-base">üü°</span><span class="text-[13px] font-medium align-middle">20 c</span></span>', roll: 40 },
    { value: 50,  label: '<span class="whitespace-nowrap"><span class="mr-1 text-lg">üü°</span><span class="text-[13px] font-medium align-middle">50 c</span></span>', roll: 40 },
    { value: 100, label: '<span class="whitespace-nowrap"><span class="text-lg">ü™ô</span><span class="ml-1 text-[13px] font-medium align-middle">1 ‚Ç¨</span></span>', roll: 25 },
    { value: 200, label: '<span class="whitespace-nowrap"><span class="text-xl">ü™ô</span><span class="ml-1 text-[13px] font-medium align-middle">2 ‚Ç¨</span></span>', roll: 25 },
  ],
  notes: [5,10,20,50,100,200,500].map(v => ({
    value: v*100,
    label:
      v === 5  ? `<span class="whitespace-nowrap"><span class="text-lg">üí∂</span> ${v} ‚Ç¨</span>` :
      v === 10 ? `<span class="whitespace-nowrap"><span class="text-lg">üí¥</span> ${v} ‚Ç¨</span>` :
      v <= 20  ? `<span class="whitespace-nowrap"><span class="text-lg">üí∑</span> ${v} ‚Ç¨</span>` :
      v <= 100 ? `<span class="whitespace-nowrap"><span class="text-xl">üíµ</span> ${v} ‚Ç¨</span>` :
                 `<span class="whitespace-nowrap"><span class="text-2xl">üí∂</span> ${v} ‚Ç¨</span>`
  }))
};

    // Etat courant
    const state = {
      fondCible: 20000, // en centimes (par d√©faut 200‚Ç¨)
      inputs: {},
      lastFondChoice: '20000'
    };

    const fmt = new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' });

    // --- Construction du tableau de saisie ---
    const tbody = document.getElementById('tbody');
    const rows = [];
function makeRow(key, label, valueCents, hasRoll){
  const tr = document.createElement('tr');
  tr.className = 'border-t border-gray-700';

  const rollsCell = hasRoll
    ? `<select data-key="${key}" data-type="rolls"
         class="appearance-none w-7 px-2 py-1 rounded-lg border border-black bg-gray-950 text-gray-100 focus:ring-2 focus:ring-gray-500 focus:border-black">
          ${[0,1,2,3].map(n=>`<option value="${n}">${n}</option>`).join('')}
       </select>`
    : `<span class="text-gray-500">‚Äî</span>`;

  tr.innerHTML = `
    <td class="p-2 text-center font-medium">
      <div class="inline-flex items-center gap-1">
        <input data-key="${key}" data-type="loose" type="number" min="0" step="1" inputmode="numeric" pattern="[0-9]*"
          class="appearance-none w-16 px-2 py-1 rounded-lg border border-black bg-gray-950 text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-gray-500 focus:border-black text-base"
  value="" placeholder="0"/>
        <button
          class="px-2 py-1 rounded-lg border border-black bg-black text-yellow-400 hover:bg-yellow-500 hover:text-black"
          data-plus="${key}" title="Ajouter au vrac">+</button>
      </div>
    </td>
    <td class="p-2 text-center font-medium">${rollsCell}</td>
    <td class="p-2 text-center font-semibold text-gray-200">${label}</td>
  <td class="p-2 text-center mono font-bold text-yellow-400 whitespace-nowrap pr-4" data-total="${key}">0,00 ‚Ç¨</td>
`;
 // <‚Äî IMPORTANT : on ferme la template string ici

  tbody.appendChild(tr);
  rows.push({ key, valueCents, hasRoll });
}


    EURO.coins.forEach((c)=>makeRow('c'+c.value, c.label, c.value, true));
    EURO.notes.forEach((n)=>makeRow('n'+n.value, n.label, n.value, false));

    // --- Utilitaires ---
    function getInputCounts(){
      const inventory = new Map();
      rows.forEach(r => {
        const loose = Number(document.querySelector(`input[data-key="${r.key}"][data-type="loose"]`).value || 0);
        const rollsEl = r.hasRoll ? document.querySelector(`select[data-key="${r.key}"][data-type="rolls"]`) : null;
        const rolls = rollsEl ? Number(rollsEl.value) : 0;
        const rollSize = r.hasRoll ? EURO.coins.find(c=>('c'+c.value)===r.key).roll : 0;
        inventory.set(r.valueCents, { loose, rolls, rollSize });
      });
      return inventory;
    }

    function computeTotals(inv){
      let total = 0;
      rows.forEach(r => {
        const { loose, rolls, rollSize } = inv.get(r.valueCents);
        const amount = (loose + rolls * rollSize) * r.valueCents;
        total += amount;
        document.querySelector(`[data-total="${r.key}"]`).textContent = fmt.format(amount/100);
      });
      document.getElementById('totalCaisse').textContent = fmt.format(total/100);
      return total;
    }

    function centsToStr(c){ return fmt.format(c/100); }

    // === 1) calcRecette (non destructif + m√©ta rouleaux cass√©s) ===
function calcRecette(inv, fondCible){
  const total = Array.from(inv.entries()).reduce((s,[v,{loose,rolls,rollSize}])=> s + (loose + rolls*rollSize)*v, 0);
  const toRecipe = total - fondCible;
  if (toRecipe < 0) {
    return { ok:false, message:`Total insuffisant pour atteindre le fond choisi (${centsToStr(fondCible)}). Manque ${centsToStr(-toRecipe)}.` };
  }
  if (toRecipe === 0) {
    return {
      ok:true,
      recette:new Map(),
      fond: structuredClone(inv), // on ne modifie jamais ta saisie
      total, fondCible, recetteTotal:0,
      metaRollsBroken:new Map(),
      metaCoinsFromRoll:new Map()
    };
  }

  // Items propos√©s au sac √† dos : billets, pi√®ces vrac, pi√®ces issues de rouleaux (p√©nalis√©es)
  const items = [];

  // Billets
  EURO.notes.forEach(n => {
    const v = n.value; const e = inv.get(v) || {loose:0, rolls:0, rollSize:0};
    if (e.loose > 0) items.push({ value:v, count:e.loose, bucket:'bill', denom:v });
  });

  // Pi√®ces vrac (prioritaires avant de casser un rouleau)
  EURO.coins.forEach(c => {
    const v = c.value; const e = inv.get(v) || {loose:0, rolls:0, rollSize:c.roll};
    if (e.loose > 0) items.push({ value:v, count:e.loose, bucket:'coinLoose', denom:v });
  });

  // Pi√®ces issues de rouleaux (stock ‚Äúvirtuel‚Äù si on casse)
  EURO.coins.forEach(c => {
    const v = c.value; const e = inv.get(v) || {loose:0, rolls:0, rollSize:c.roll};
    const stockFromRolls = (e.rolls||0) * (e.rollSize||c.roll);
    if (stockFromRolls > 0) items.push({ value:v, count:stockFromRolls, bucket:'coinFromRoll', denom:v });
  });

  // Co√ªt unitaire (plus petit = plus pr√©f√©r√©)
  function unitCost(it){
    const base =
      it.bucket==='bill'        ?  800 :   // favorise les billets
      it.bucket==='coinLoose'   ? 2000 :   // puis pi√®ces vrac
                                  4000 ;   // pi√®ces issues de rouleaux (p√©nalis√©es)
    const epsilon = 0.01;
    return base - epsilon * it.denom; // √† co√ªt √©gal, pr√©f√®re grosses d√©nominations
  }

  // Bounded knapsack par binary splitting
  const chunks = [];
  items.forEach(it => {
    let k = it.count, pow = 1;
    while (k > 0){
      const take = Math.min(pow, k);
      const amount = it.value * take;
      const cost = unitCost(it) * take;
      chunks.push({ amount, cost, trace:{ bucket:it.bucket, denom:it.denom, take } });
      k -= take; pow *= 2;
    }
  });

  const R = toRecipe;
  const INF = 1e15;
  const dp = new Float64Array(R+1);
  const prev = new Int32Array(R+1);
  const used = new Int32Array(R+1);
  for(let i=1;i<=R;i++){ dp[i]=INF; prev[i]=-1; used[i]=-1; }
  dp[0]=0; prev[0]=-1; used[0]=-1;

  chunks.forEach((ch, idx) => {
    for(let a=R; a>=ch.amount; a--){
      const cand = dp[a - ch.amount] + ch.cost;
      if (cand < dp[a]) { dp[a] = cand; prev[a] = a - ch.amount; used[a] = idx; }
    }
  });

  if (!isFinite(dp[R]) || dp[R] >= INF){
    return { ok:false, message:`Impossible d'atteindre exactement la recette ${centsToStr(R)} avec les valeurs disponibles.` };
  }

  // Reconstruction : combien pris en billets / pi√®ces (vrac vs rouleaux)
  const takeBill = new Map();          // denom -> nb billets
  const takeCoinLoose = new Map();     // denom -> nb pi√®ces depuis vrac
  const takeCoinFromRoll = new Map();  // denom -> nb pi√®ces en cassant des rouleaux

  let cur = R;
  while (cur > 0){
    const ch = chunks[used[cur]];
    const d = ch.trace.denom;
    if (ch.trace.bucket==='bill')           takeBill.set(d, (takeBill.get(d)||0) + ch.trace.take);
    else if (ch.trace.bucket==='coinLoose') takeCoinLoose.set(d, (takeCoinLoose.get(d)||0) + ch.trace.take);
    else                                    takeCoinFromRoll.set(d, (takeCoinFromRoll.get(d)||0) + ch.trace.take);
    cur = prev[cur];
  }

  // Sortie "recette" pour le rendu (pi√®ces/billets uniquement, jamais ‚Äú1√ó 25 ‚Ç¨‚Äù)
  const recetteMap = new Map();
  EURO.coins.forEach(c => {
    const v = c.value;
    const coins = (takeCoinLoose.get(v)||0) + (takeCoinFromRoll.get(v)||0);
    recetteMap.set(v, { bill:0, coin:coins, roll:0, rollSize: inv.get(v)?.rollSize || c.roll });
  });
  EURO.notes.forEach(n => {
    const v = n.value;
    recetteMap.set(v, { bill:(takeBill.get(v)||0), coin:0, roll:0, rollSize: 0 });
  });

  const recetteTotal = Array.from(recetteMap.entries()).reduce((s,[v,obj]) => s + v*(obj.bill + obj.coin), 0);

  // Fond renvoy√© = clone exact (on ne modifie pas ta fiche)
  const fondClone = structuredClone(inv);

  // M√©ta : combien de rouleaux ‚Äúvirtuellement‚Äù cass√©s & nb de pi√®ces issues de rouleaux
  const metaRollsBroken = new Map();
  const metaCoinsFromRoll = new Map();
  EURO.coins.forEach(c => {
    const v = c.value;
    const fromRoll = (takeCoinFromRoll.get(v)||0);
    if (fromRoll > 0){
      const size = inv.get(v)?.rollSize || c.roll;
      const rollsToBreak = Math.ceil(fromRoll / size);
      metaRollsBroken.set(v, rollsToBreak);
      metaCoinsFromRoll.set(v, fromRoll);
    }
  });

  return {
    ok:true,
    recette:recetteMap,
    fond: fondClone,
    total, fondCible, recetteTotal,
    metaRollsBroken,
    metaCoinsFromRoll
  };
}


// === renderRecetteOrdered avec emojis par d√©nomination + nombre en gras ===
function renderRecetteOrdered(container, map, metaCoinsFromRoll = new Map()){
  container.innerHTML = '';

  // petit helper pour fabriquer l‚Äôemoji correspondant √† la d√©nomination
  function createDenomIcon(type, valueCents){
    const span = document.createElement('span');
    // Pi√®ces
    if (type === 'coin'){
      switch (valueCents){
        case 1:   span.textContent = 'üü§'; span.className = 'text-[10px]'; break; // 1 c
        case 2:   span.textContent = 'üü§'; span.className = 'text-[11px]'; break; // 2 c
        case 5:   span.textContent = 'üü§'; span.className = 'text-xs';     break; // 5 c
        case 10:  span.textContent = 'üü°'; span.className = 'text-sm';     break; // 10 c
        case 20:  span.textContent = 'üü°'; span.className = 'text-base';   break; // 20 c
        case 50:  span.textContent = 'üü°'; span.className = 'text-lg';     break; // 50 c
        case 100: span.textContent = 'ü™ô'; span.className = 'text-lg';     break; // 1 ‚Ç¨
        case 200: span.textContent = 'ü™ô'; span.className = 'text-xl';     break; // 2 ‚Ç¨
        default:  span.textContent = 'üü°'; // fallback
      }
    } else {
      // Billets ‚Äî on reprend ta logique d‚Äôemoji utilis√©e dans les labels
      const v = valueCents / 100;
      if (v === 5)        { span.textContent = 'üí∂'; span.className = 'text-lg'; }
      else if (v === 10)  { span.textContent = 'üí¥'; span.className = 'text-lg'; }
      else if (v <= 20)   { span.textContent = 'üí∑'; span.className = 'text-lg'; }
      else if (v <= 100)  { span.textContent = 'üíµ'; span.className = 'text-xl'; }
      else                { span.textContent = 'üí∂'; span.className = 'text-2xl'; }
    }
    return span;
  }

  // ordre: pi√®ces (petites -> grosses), puis billets (petits -> gros)
  const order = EURO.coins.map(c=>({v:c.value, type:'coin'}))
                .concat(EURO.notes.map(n=>({v:n.value, type:'bill'})));

  let any = false;

  order.forEach(({ v, type }) => {
    const obj = map.get(v);
    if (!obj) return;

    const line = document.createElement('div');
    line.className = 'text-base font-semibold text-gray-100';

    const segments = [];

    // Pi√®ces
    if (type==='coin' && obj.coin) {
      const seg = document.createElement('span');
      seg.className = 'inline-flex items-center gap-1';

      // nombre en GRAS
      const strong = document.createElement('strong');
      strong.className = 'font-extrabold';
      strong.textContent = String(obj.coin);

      // contenu : **N**√ó 1,00 ‚Ç¨
      seg.appendChild(strong);
      seg.appendChild(document.createTextNode('√ó ' + fmt.format(v/100) + ' '));

      // emoji sp√©cifique √† la d√©nomination (plac√© juste apr√®s la valeur)
      seg.appendChild(createDenomIcon('coin', v));

      // alerte si rouleau cass√© pour cette d√©nomination
      const fromRoll = metaCoinsFromRoll.get(v) || 0;
      if (fromRoll > 0) {
        seg.appendChild(document.createTextNode(' '));
        const warn = document.createElement('span');
        warn.textContent = '(‚ö†Ô∏è Rouleau cass√©)';
        seg.appendChild(warn);
      }

      segments.push(seg);
    }

    // Billets
    if (type==='bill' && obj.bill) {
      const seg = document.createElement('span');
      seg.className = 'inline-flex items-center gap-1';

      const strong = document.createElement('strong');
      strong.className = 'font-extrabold';
      strong.textContent = String(obj.bill);

      seg.appendChild(strong);
      seg.appendChild(document.createTextNode('√ó ' + fmt.format(v/100) + ' '));

      // emoji sp√©cifique au billet
      seg.appendChild(createDenomIcon('bill', v));

      segments.push(seg);
    }

    if (segments.length){
      any = true;
      segments.forEach((seg, i) => {
        line.appendChild(seg);
        if (i < segments.length - 1){
          const sep = document.createElement('span');
          sep.textContent = '  ‚Ä¢  ';
          line.appendChild(sep);
        }
      });
      container.appendChild(line);
    }
  });

  if (!any){ container.innerHTML = '<div class="text-gray-500">‚Äî</div>'; }
}


// Restaurer les donn√©es si dispo
const saved = localStorage.getItem("octocash-data");
if (saved) {
  const inv = new Map(Object.entries(JSON.parse(saved)).map(([k,v]) => [Number(k), v]));

  rows.forEach(r => {
    const entry = inv.get(r.valueCents);
    if (entry) {
      // Remplir les champs
      const input = document.querySelector(`input[data-key="${r.key}"][data-type="loose"]`);
      if (input) input.value = entry.loose || "";

      if (r.hasRoll) {
        const select = document.querySelector(`select[data-key="${r.key}"][data-type="rolls"]`);
        if (select) select.value = entry.rolls || "0";
      }
    }
  });
}
    // --- Interactions UI ---
    function refreshTotals(){
  const inv = getInputCounts();
  computeTotals(inv);

  // Sauvegarde dans localStorage
  localStorage.setItem("octocash-data", JSON.stringify(Object.fromEntries(inv)));
}

    // Recalcul en live
    tbody.addEventListener('input', refreshTotals);
    tbody.addEventListener('change', refreshTotals);

    // Boutons "+" -> fen√™tre de saisie et addition au vrac
tbody.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-plus]');
  if (!btn) return;

  const key = btn.dataset.plus;
  const input = document.querySelector(`input[data-key="${key}"][data-type="loose"]`);
  if (!input) return;

  // R√©cup√®re l‚Äôintitul√© (ex: "2 ‚Ç¨", "10 c", etc.) pour l‚Äôafficher dans le prompt
  const labelCell = btn.closest('tr')?.querySelector('td:nth-child(3)');
  const denomText = labelCell ? labelCell.textContent.trim() : '';

  // Demande combien ajouter (entier)
  let q = prompt(`Ajouter combien de ${denomText} ?`);

  if (q === null) return; // Annul√©

  // Convertit "2,5" -> 2 (entier, pas de d√©cimales pour un nombre de pi√®ces/billets)
  q = String(q).replace(',', '.');
  const add = Math.floor(Number(q));

  if (!Number.isFinite(add) || add <= 0) {
    // Valeur invalide -> on ne fait rien
    return;
  }

  const current = Math.floor(Number(input.value || 0)) || 0;
  input.value = String(current + add);

  // Recalcule et garde une UX agr√©able
  refreshTotals();
  input.focus();
  try { // place le curseur en fin si support√©
    const len = input.value.length;
    input.setSelectionRange(len, len);
  } catch {}
});


    // --- Modale fond ---
    const modal = document.getElementById('fondModal');
    const radios = () => Array.from(document.querySelectorAll('input[name="fondChoice"]'));
    function openModal(){
      const toSelect = state.lastFondChoice;
      radios().forEach(r=>{ r.checked = (r.value===toSelect); });
      const customInput = document.getElementById('fondCustom');
      if (customInput) customInput.value = '';
      document.getElementById('fondCustomHint').classList.add('hidden');
      modal.classList.remove('hidden');
      document.body.classList.add('modal-open');
    }
    function closeModal(){
      modal.classList.add('hidden');
      document.body.classList.remove('modal-open');
    }

    modal.addEventListener('click', (e)=>{
      if (e.target.dataset.close === 'backdrop') closeModal();
    });
    document.getElementById('fondCancel').addEventListener('click', closeModal);

    document.getElementById('fondCustom').addEventListener('input', ()=>{
      const customRadio = radios().find(r=>r.value==='custom');
      if (customRadio) customRadio.checked = true;
    });

    document.getElementById('fondConfirm').addEventListener('click', ()=>{
      const choice = radios().find(r=>r.checked);
      if (!choice) return;
      let fond = state.fondCible;
      if (choice.value === 'custom'){
        const valStr = document.getElementById('fondCustom').value.trim();
        const num = Number(valStr.replace(',', '.'));
        if (isNaN(num) || num < 0){
          document.getElementById('fondCustomHint').classList.remove('hidden');
          return;
        }
        fond = Math.round(num * 100);
        state.lastFondChoice = 'custom';
      } else {
        fond = Number(choice.value);
        state.lastFondChoice = choice.value;
      }
      state.fondCible = fond;
      closeModal();
      runCalculation();
    });

    // Bouton Calculer -> ouvre la modale
    document.getElementById('btnCalculer').addEventListener('click', openModal);

function runCalculation(){
  const inv = getInputCounts();
  const res = calcRecette(inv, state.fondCible);
  const resultSec = document.getElementById('resultats');
  document.getElementById('fondActuelBadge').textContent = centsToStr(state.fondCible);

  if (!res.ok){
    resultSec.hidden = false;
    document.getElementById('valRecette').textContent = res.message;
    document.getElementById('detailRecette').innerHTML = '';
    return;
  }

  document.getElementById('valRecette').textContent = centsToStr(res.recetteTotal);

  // ‚¨áÔ∏è on transmet la m√©ta pour afficher ‚Äú(attention rouleau cass√©)‚ö†Ô∏è‚Äù si besoin
  renderRecetteOrdered(document.getElementById('detailRecette'), res.recette, res.metaCoinsFromRoll);

  resultSec.hidden = false;

  // ‚úÖ Sauvegarder le dernier calcul (pour r√©ouverture)
  localStorage.setItem("octocash-last", JSON.stringify({
    fondCible: state.fondCible,                                  // en centimes
    recette: Array.from(res.recette.entries()),                  // Map -> Array
    metaCoinsFromRoll: Array.from(res.metaCoinsFromRoll.entries()),
    recetteTotal: res.recetteTotal                               // en centimes
  }));
}


// R√©initialiser
document.getElementById('btnReset').addEventListener('click', () => {
  document.querySelectorAll('#tbody input').forEach(i => i.value = '');
  document.querySelectorAll('#tbody select').forEach(s => s.value = '0');
  refreshTotals();
  document.getElementById('resultats').hidden = true;
});

// init
refreshTotals();

// ‚úÖ Restauration du dernier calcul (d√©tail recette + fond choisi)
(function restoreLastCalc(){
  const raw = localStorage.getItem("octocash-last");
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    if (typeof data.fondCible === 'number') state.fondCible = data.fondCible;

    const recetteMap = new Map(data.recette || []);                       // Array -> Map
    const metaCoinsFromRoll = new Map(data.metaCoinsFromRoll || []);

    document.getElementById('fondActuelBadge').textContent = centsToStr(state.fondCible || 0);
    document.getElementById('valRecette').textContent = centsToStr(data.recetteTotal || 0);
    renderRecetteOrdered(document.getElementById('detailRecette'), recetteMap, metaCoinsFromRoll);
    document.getElementById('resultats').hidden = false;
  } catch (e) {
    console.warn("Erreur restauration dernier calcul", e);
  }
})();

  </script>
</body>
</html>
