<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OctoCash</title>

  <!-- Ic√¥ne et manifest -->
  <link rel="icon" type="image/png" href="https://i.postimg.cc/W42shZTD/Chat-GPT-Image-22-sept-2025-19-00-20.png">
<link rel="apple-touch-icon" href="https://i.postimg.cc/W42shZTD/Chat-GPT-Image-22-sept-2025-19-00-20.png">
<meta name="apple-mobile-web-app-title" content="OctoCash">
<meta name="application-name" content="OctoCash">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* === Fond tentacules (gris sombre + or) === */
    :root {
      --bg-url: url('https://i.postimg.cc/fbwbZdVb/Chat-GPT-Image-22-sept-2025-14-08-38.png');
      --gold: #ffd166; /* accent or */
    }

    html, body { height: 100%; }

    body {
      background: #111;
      color: #f1f1f1;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(to bottom, rgba(0,0,0,.3), rgba(0,0,0,.6)),
        var(--bg-url);
      background-size: cover;
      background-position: center top;
      background-repeat: no-repeat;
      z-index: -1;
    }
    @media (max-width: 640px){
      body::before { position: absolute; }
    }

    @media (max-width: 420px){
  /* compacter le tableau */
  table.w-full td, table.w-full th { padding: .35rem .4rem; }
  /* r√©duire un poil la taille du total pour √©viter les coupes */
  #totalCaisse { font-size: 1.5rem; } /* avant: text-2xl ~1.5rem, ajuste si besoin */
  /* inputs + select un peu plus √©troits */
  #tbody input[type="number"] { width: 3.5rem; }  /* ~56px */
  #tbody select { width: 1.5rem; padding-left: .25rem; padding-right: .25rem; }
}

    /* Inputs num√©riques -> clavier num√©rique sur mobile et suppression du style bleu */
    input[type=number],
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-color: #0a0a0a !important;
      color: #f1f1f1 !important;
      border: 1px solid #000 !important;
      box-shadow: none !important;
      outline: none;
    }
    /* Supprimer les fl√®ches ‚Üë‚Üì des input number */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    /* Utilitaires */
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sticky-cta { position: sticky; bottom: 0; background: rgba(24,24,24,0.95); padding: .5rem; border-top: 1px solid rgba(120,120,120,.35); backdrop-filter: blur(6px); }

    /* Mise en avant des totaux */
    #totalCaisse { color: var(--gold); text-shadow: 0 0 6px rgba(255,210,80,.25); }
    [data-total] { font-weight: 700; color: var(--gold); }

    /* Tables/cards en gris neutre */
    table thead { background: rgba(75,75,75,.9); }
    table tfoot { background: rgba(45,45,45,.9); }
    .card { background: rgba(32,32,32,.85); border: 1px solid rgba(120,120,120,.45); }

    /* Radios custom or, sans bleu */
    .radio-gold {
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      width: 1.25rem; height: 1.25rem; border-radius: 9999px;
      border: 2px solid #bbb;
      background-color: #333;
      cursor: pointer; position: relative; display: inline-block;
    }
    .radio-gold:checked {
      background-color: #ffd166;
      border-color: #ffd166;
    }

    #fondCancel {
      background-color: #1f1f1f !important;
      color: #e5e5e5 !important;
      border: 1px solid #444 !important;
    }
    #fondCancel:hover { background-color: #333 !important; }

    /* Radios + labels du modal : pas de bleu, style dark+or */
    #fondModal, #fondModal * { -webkit-tap-highlight-color: transparent; }
    #fondModal label { user-select: none; }
    #fondModal label {
      background-color: rgba(0,0,0,.20) !important;
      border-color: #565656 !important;
      transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    #fondModal label:hover {
      background-color: #2b2b2b !important;
      border-color: #6b6b6b !important;
    }
    #fondModal input[type="radio"].radio-gold:focus {
      outline: none !important;
      box-shadow: 0 0 0 2px rgba(255,209,102,.25);
      border-radius: 9999px;
    }
    #fondModal label:has(.radio-gold:checked) {
      background-color: #1f1a12 !important;
      border-color: #b08900 !important;
      box-shadow: 0 0 0 2px rgba(255,209,102,.30);
    }
    #fondModal ::selection { background: rgba(255,209,102,.28); color: #fff; }

    /* Signature */
    .signature {
      margin: 2rem auto 1.5rem;
      display: flex; align-items: center; justify-content: center; gap: .6rem;
      color: #e5e5e5; opacity: .85; font-weight: 600;
    }
    .signature svg { width: 18px; height: 18px; display: inline-block; }

/* Emp√™che le zoom automatique sur iOS quand on clique sur un input */
  input,
  select,
  textarea {
    font-size: 16px !important;
  }
  </style>
</head>
<body class="min-h-screen text-gray-100">
  <div class="max-w-md mx-auto p-4 pb-28">
    <!-- (Titres supprim√©s comme demand√©) -->

    <!-- Tableau de saisie -->
    <section class="mb-4">
      <div class="rounded-2xl shadow-sm overflow-hidden card">
        <table class="w-full text-sm">
          <thead class="text-gray-200">
  <tr>
    <th class="text-center p-2 w-[72px] sm:w-[84px]">Vrac üü°</th>
    <th class="text-left p-2 w-[50px]  sm:w-[58px]">Rouleaux</th>
    <th class="text-center p-2 w-[86px]  sm:w-[100px]">Valeur ‚Ç¨</th>
    <th class="text-left p-2">Total üí∞</th>
  </tr>
</thead>


          <tbody id="tbody" class="divide-y divide-gray-700"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="p-2 text-lg font-semibold text-gray-200">Total caisse :</td>
              <td class="p-2 text-right mono font-bold text-yellow-400 whitespace-nowrap pr-2 sm:pr-4 inline-block" data-total="${key}">0,00 ‚Ç¨</td>

          </tfoot>
        </table>
      </div>
    </section>

    <!-- Actions principales -->
    <section class="sticky-cta rounded-2xl">
      <div class="flex items-center gap-2">
        <button id="btnCalculer" class="flex-1 px-4 py-3 rounded-2xl bg-yellow-400 text-black font-semibold shadow hover:bg-yellow-300 active:translate-y-px">Calculer la recette</button>
        <button id="btnReset" class="px-4 py-3 rounded-2xl bg-black text-gray-200 hover:bg-gray-900">R√©initialiser</button>
      </div>
    </section>

    <!-- R√©sultats -->
    <section class="mt-4" id="resultats" hidden>
      <div class="rounded-2xl shadow-sm p-3 card">
        <div class="grid grid-cols-1 gap-3">
          <div class="p-3 rounded-xl bg-gray-800/70 border border-gray-600 text-center">
            <div class="text-sm uppercase tracking-wide text-gray-400">RECETTE √Ä ENVOYER ‚úâÔ∏è</div>
            <div class="text-2xl font-bold mono text-yellow-400" id="valRecette">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="rounded-2xl shadow-sm p-3 mt-3 card">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-yellow-400">D√âTAIL RECETTE :</h4>
          <span class="text-sm text-gray-400">Fond s√©lectionn√© : <strong id="fondActuelBadge" class="text-gray-100">200,00 ‚Ç¨</strong></span>
        </div>
        <div id="detailRecette" class="text-sm space-y-1 text-center"></div>
      </div>
    </section>
  </div>

<!-- Signature -->
<div class="signature text-yellow-300 italic font-light tracking-wide text-base flex items-center justify-center gap-1 mt-6" style="transform: skewX(-10deg);">
  By Edithe üíõ 
    <path d="M12 21s-6.716-4.373-9.33-7.117C.93 11.02 1.238 7.94 3.343 6.02 5.26 4.288 8.093 4.61 10 6.243c1.907-1.633 4.74-1.955 6.657-.223 2.105 1.92 2.413 5 .673 7.863C18.716 16.627 12 21 12 21z"/>
  </svg>
</div>

  <!-- MODAL de s√©lection du fond -->
  <div id="fondModal" class="fixed inset-0 z-50 hidden" aria-labelledby="fondTitle" aria-modal="true" role="dialog">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close="backdrop"></div>
    <div class="relative max-w-md mx-auto mt-24 card rounded-2xl shadow-xl overflow-hidden">
      <div class="p-4 border-b border-gray-700">
        <h3 id="fondTitle" class="text-lg font-semibold text-yellow-400">Choisir le fond de caisse</h3>
        <p class="text-sm text-gray-400">S√©lectionnez un fond √† conserver avant de calculer la recette.</p>
      </div>
      <div class="p-4 space-y-3">
        <!-- Billetterie -->
        <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-700 hover:bg-gray-800 cursor-pointer">
          <input type="radio" name="fondChoice" value="20000" class="radio-gold" />
          <div>
            <div class="font-medium">Fond Billetterie</div>
            <div class="text-lg font-semibold text-yellow-400">200,00 ‚Ç¨</div>
          </div>
        </label>
        <!-- Boutique -->
        <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-700 hover:bg-gray-800 cursor-pointer">
          <input type="radio" name="fondChoice" value="25000" class="radio-gold" />
          <div>
            <div class="font-medium">Fond Boutique</div>
            <div class="text-lg font-semibold text-yellow-400">250,00 ‚Ç¨</div>
          </div>
        </label>
        <!-- Fond personnalis√© (tout le bloc cliquable comme les autres) -->
        <label for="fondCustomRadio" class="flex items-start gap-3 p-3 rounded-xl border border-gray-700 hover:bg-gray-800 cursor-pointer">
          <input type="radio" id="fondCustomRadio" name="fondChoice" value="custom" class="radio-gold mt-1" />
          <div class="flex-1">
            <div class="font-medium">Fond personnalis√©</div>
            <div class="mt-1 flex items-center gap-2">
              <input id="fondCustom" type="number" step="0.01" inputmode="decimal"
                     class="w-32 px-2 py-1 rounded-lg border border-gray-700 bg-gray-800 text-gray-100"
                     placeholder="ex : 150" />
              <span class="text-xs text-gray-400">‚Ç¨</span>
            </div>
          </div>
        </label>
        <p id="fondCustomHint" class="mt-2 text-xs text-rose-400 hidden">Veuillez saisir un montant valide ‚â• 0.</p>
      </div>
      <div class="p-4 border-t border-gray-700 flex items-center justify-end gap-2">
        <button id="fondCancel" class="px-3 py-2 rounded-xl">Annuler</button>
        <button id="fondConfirm" class="px-4 py-2 rounded-xl bg-yellow-400 text-black font-semibold hover:bg-yellow-300">Confirmer</button>
      </div>
    </div>
  </div>

  <script>
    // --- Mod√®le des d√©nominations (centimes) ---
    const EURO = {
  coins: [
    { value: 1,   label: '<span class="whitespace-nowrap"><span class="text-[10px]">üü§</span><span class="ml-1 text-[13px] font-medium align-middle">1 c</span></span>', roll: 50 },
    { value: 2,   label: '<span class="whitespace-nowrap"><span class="text-[11px]">üü§</span><span class="ml-1 text-[13px] font-medium align-middle">2 c</span></span>', roll: 50 },
    { value: 5,   label: '<span class="whitespace-nowrap"><span class="text-xs">üü§</span><span class="ml-1 text-[13px] font-medium align-middle">5 c</span></span>', roll: 50 },
    { value: 10,  label: '<span class="whitespace-nowrap"><span class="mr-1 text-sm">üü°</span><span class="text-[13px] font-medium align-middle">10 c</span></span>', roll: 40 },
    { value: 20,  label: '<span class="whitespace-nowrap"><span class="mr-1 text-base">üü°</span><span class="text-[13px] font-medium align-middle">20 c</span></span>', roll: 40 },
    { value: 50,  label: '<span class="whitespace-nowrap"><span class="mr-1 text-lg">üü°</span><span class="text-[13px] font-medium align-middle">50 c</span></span>', roll: 40 },
    { value: 100, label: '<span class="whitespace-nowrap"><span class="text-lg">ü™ô</span><span class="ml-1 text-[13px] font-medium align-middle">1 ‚Ç¨</span></span>', roll: 25 },
    { value: 200, label: '<span class="whitespace-nowrap"><span class="text-xl">ü™ô</span><span class="ml-1 text-[13px] font-medium align-middle">2 ‚Ç¨</span></span>', roll: 25 },
  ],
  notes: [5,10,20,50,100,200,500].map(v => ({
    value: v*100,
    label:
      v === 5  ? `<span class="whitespace-nowrap"><span class="text-lg">üí∂</span> ${v} ‚Ç¨</span>` :
      v === 10 ? `<span class="whitespace-nowrap"><span class="text-lg">üí¥</span> ${v} ‚Ç¨</span>` :
      v <= 20  ? `<span class="whitespace-nowrap"><span class="text-lg">üí∑</span> ${v} ‚Ç¨</span>` :
      v <= 100 ? `<span class="whitespace-nowrap"><span class="text-xl">üíµ</span> ${v} ‚Ç¨</span>` :
                 `<span class="whitespace-nowrap"><span class="text-2xl">üí∂</span> ${v} ‚Ç¨</span>`
  }))
};

    // Etat courant
    const state = {
      fondCible: 20000, // en centimes (par d√©faut 200‚Ç¨)
      inputs: {},
      lastFondChoice: '20000'
    };

    const fmt = new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' });

    // --- Construction du tableau de saisie ---
    const tbody = document.getElementById('tbody');
    const rows = [];
function makeRow(key, label, valueCents, hasRoll){
  const tr = document.createElement('tr');
  tr.className = 'border-t border-gray-700';

  const rollsCell = hasRoll
    ? `<select data-key="${key}" data-type="rolls"
         class="appearance-none w-7 px-2 py-1 rounded-lg border border-black bg-gray-950 text-gray-100 focus:ring-2 focus:ring-gray-500 focus:border-black">
          ${[0,1,2,3].map(n=>`<option value="${n}">${n}</option>`).join('')}
       </select>`
    : `<span class="text-gray-500">‚Äî</span>`;

  tr.innerHTML = `
    <td class="p-2 text-center font-medium">
      <div class="inline-flex items-center gap-1">
        <input data-key="${key}" data-type="loose" type="number" min="0" step="1" inputmode="numeric" pattern="[0-9]*"
          class="appearance-none w-16 px-2 py-1 rounded-lg border border-black bg-gray-950 text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-gray-500 focus:border-black text-sm"
          value="" placeholder="0"/>
        <button
          class="px-2 py-1 rounded-lg border border-black bg-black text-yellow-400 hover:bg-yellow-500 hover:text-black"
          data-plus="${key}" title="Ajouter au vrac">+</button>
      </div>
    </td>
    <td class="p-2 text-center font-medium">${rollsCell}</td>
    <td class="p-2 text-center font-semibold text-gray-200">${label}</td>
    <td class="p-2 text-right mono font-bold text-yellow-400 whitespace-nowrap pr-4 d-inline-block" data-total="${key}">0,00 ‚Ç¨</td>
  `; // <‚Äî IMPORTANT : on ferme la template string ici

  tbody.appendChild(tr);
  rows.push({ key, valueCents, hasRoll });
}


    EURO.coins.forEach((c)=>makeRow('c'+c.value, c.label, c.value, true));
    EURO.notes.forEach((n)=>makeRow('n'+n.value, n.label, n.value, false));

    // --- Utilitaires ---
    function getInputCounts(){
      const inventory = new Map();
      rows.forEach(r => {
        const loose = Number(document.querySelector(`input[data-key="${r.key}"][data-type="loose"]`).value || 0);
        const rollsEl = r.hasRoll ? document.querySelector(`select[data-key="${r.key}"][data-type="rolls"]`) : null;
        const rolls = rollsEl ? Number(rollsEl.value) : 0;
        const rollSize = r.hasRoll ? EURO.coins.find(c=>('c'+c.value)===r.key).roll : 0;
        inventory.set(r.valueCents, { loose, rolls, rollSize });
      });
      return inventory;
    }

    function computeTotals(inv){
      let total = 0;
      rows.forEach(r => {
        const { loose, rolls, rollSize } = inv.get(r.valueCents);
        const amount = (loose + rolls * rollSize) * r.valueCents;
        total += amount;
        document.querySelector(`[data-total="${r.key}"]`).textContent = fmt.format(amount/100);
      });
      document.getElementById('totalCaisse').textContent = fmt.format(total/100);
      return total;
    }

    function centsToStr(c){ return fmt.format(c/100); }

    // --- Calcul de la recette par DP (pr√©f√©rence gros billets, vrac > rouleaux) ---
    function calcRecette(inv, fondCible){
      const total = Array.from(inv.entries()).reduce((s,[v,{loose,rolls,rollSize}])=> s + (loose + rolls*rollSize)*v, 0);
      const toRecipe = total - fondCible;
      if (toRecipe < 0) {
        return { ok:false, message:`Total insuffisant pour atteindre le fond choisi (${centsToStr(fondCible)}). Manque ${centsToStr(-toRecipe)}.` };
      }
      if (toRecipe === 0) {
        return { ok:true, recette: new Map(), fond: structuredClone(inv), total, fondCible, recetteTotal:0 };
      }

      const items = [];
      // Billets (bucket 'bill')
      EURO.notes.forEach(n => {
        const v = n.value; const entry = inv.get(v) || {loose:0, rolls:0, rollSize:0};
        if (entry.loose>0) items.push({ value:v, count:entry.loose, unitLabel:n.label, bucket:'bill', denom:v });
      });
      // Pi√®ces en vrac (bucket 'coin')
      EURO.coins.forEach(c => {
        const v = c.value; const entry = inv.get(v) || {loose:0, rolls:0, rollSize:c.roll};
        if (entry.loose>0) items.push({ value:v, count:entry.loose, unitLabel:c.label, bucket:'coin', denom:v });
      });
      // Pi√®ces en rouleaux (bucket 'roll')
      EURO.coins.forEach(c => {
        const v = c.value; const entry = inv.get(v) || {loose:0, rolls:0, rollSize:c.roll};
        if (entry.rolls>0) items.push({ value:v*c.roll, count:entry.rolls, unitLabel:`${c.label} (rouleau x${c.roll})`, bucket:'roll', denom:v });
      });

      function unitCost(it){
        const denom = it.bucket==='roll' ? it.denom : it.value;
        const base = it.bucket==='bill' ? 1000 : (it.bucket==='coin' ? 2000 : 10000);
        const epsilon = 0.01;
        return base - epsilon * denom;
      }

      // D√©composition binaire born√©e -> 0/1 knapsack
      const chunks = [];
      items.forEach(it => {
        let k = it.count, pow = 1;
        while (k>0){
          const take = Math.min(pow, k);
          const amount = (it.bucket==='roll') ? it.value : it.value * take;
          const cost = unitCost(it) * take;
          chunks.push({ amount, cost, trace:{ bucket:it.bucket, denom:it.denom, unitValue:it.value, take } });
          k -= take; pow *= 2;
        }
      });

      const R = toRecipe;
      const INF = 1e15;
      const dp = new Float64Array(R+1);
      const prev = new Int32Array(R+1);
      const used = new Int32Array(R+1);
      for(let i=1;i<=R;i++){ dp[i]=INF; prev[i]=-1; used[i]=-1; }
      dp[0]=0; prev[0]=-1; used[0]=-1;

      chunks.forEach((ch, idx) => {
        for(let a=R; a>=ch.amount; a--){
          const cand = dp[a - ch.amount] + ch.cost;
          if (cand < dp[a]) { dp[a] = cand; prev[a] = a - ch.amount; used[a] = idx; }
        }
      });

      if (!isFinite(dp[R]) || dp[R] >= INF){
        return { ok:false, message:`Impossible d'atteindre exactement la recette ${centsToStr(R)} avec les valeurs disponibles.` };
      }

      // Reconstruction
      const recetteDetail = new Map();
      let cur = R;
      while (cur > 0){
        const idx = used[cur];
        const ch = chunks[idx];
        const key = ch.trace.bucket+":"+ch.trace.denom+":"+ch.trace.unitValue;
        recetteDetail.set(key, (recetteDetail.get(key)||0) + ch.trace.take);
        cur = prev[cur];
      }

      const recetteMap = new Map();
      const fondMap = new Map();

      inv.forEach((e, v) => {
        fondMap.set(v, { loose: e.loose, rolls: e.rolls, rollSize: e.rollSize });
        recetteMap.set(v, { bill:0, coin:0, roll:0, rollSize: e.rollSize });
      });

      recetteDetail.forEach((take, key) => {
        const [bucket, denomStr, unitValStr] = key.split(":");
        const denom = Number(denomStr);
        const unitVal = Number(unitValStr);
        const target = recetteMap.get(bucket==='roll' ? denom : unitVal) || { bill:0, coin:0, roll:0 };
        if (bucket==='bill') {
          target.bill += take;
          fondMap.get(unitVal).loose -= take;
        } else if (bucket==='coin') {
          target.coin += take;
          fondMap.get(unitVal).loose -= take;
        } else {
          target.roll += take;
          const fm = fondMap.get(denom);
          fm.rolls -= take;
        }
        recetteMap.set(bucket==='roll' ? denom : unitVal, target);
      });

      const recetteTotal = Array.from(recetteMap.entries()).reduce((s,[v,obj])=>{
        const rollSize = (fondMap.get(v)?.rollSize)||0;
        return s + (obj.bill * v) + (obj.coin * v) + (obj.roll * (v * rollSize));
      }, 0);

      return { ok:true, recette:recetteMap, fond:fondMap, total, fondCible, recetteTotal };
    }

    // --- Rendu r√©sultats (pi√®ces -> billets) ---
function renderRecetteOrdered(container, map){
  container.innerHTML = '';

  const order = EURO.coins.map(c=>({v:c.value}))
                  .concat(EURO.notes.map(n=>({v:n.value})));

  let any = false;

  order.forEach(({ v }) => {
    const obj = map.get(v);
    if (!obj) return;

    const rollSize = obj.rollSize || 0;
    const line = document.createElement('div');
    line.className = 'text-base font-semibold text-gray-100'; // un peu plus gros/√©pais

    const segments = [];

    // Pi√®ces en vrac
    if (obj.coin) {
      const seg = document.createElement('span');
      seg.className = 'inline-flex items-center gap-1';
      seg.textContent = `${obj.coin}√ó ${fmt.format(v/100)} `;
      const emoji = document.createElement('span');
      emoji.textContent = 'üü°';
      seg.appendChild(emoji);
      segments.push(seg);
    }

    // Rouleaux (pi√®ces)
    if (obj.roll) {
      const seg = document.createElement('span');
      seg.className = 'inline-flex items-center gap-1';
      seg.textContent = `${obj.roll}√ó ${fmt.format((v*rollSize)/100)} `;
      const emoji = document.createElement('span');
      emoji.textContent = 'üü°';
      seg.appendChild(emoji);
      segments.push(seg);
    }

    // Billets
    if (obj.bill) {
      const seg = document.createElement('span');
      seg.className = 'inline-flex items-center gap-1';
      seg.textContent = `${obj.bill}√ó ${fmt.format(v/100)} `;
      const emoji = document.createElement('span');
      emoji.textContent = 'üí∂';
      seg.appendChild(emoji);
      segments.push(seg);
    }

    if (segments.length){
      any = true;
      // ajouter avec s√©parateurs " ‚Ä¢ "
      segments.forEach((seg, i) => {
        line.appendChild(seg);
        if (i < segments.length - 1){
          const sep = document.createElement('span');
          sep.textContent = '  ‚Ä¢  ';
          line.appendChild(sep);
        }
      });
      container.appendChild(line);
    }
  });

  if (!any){ container.innerHTML = '<div class="text-gray-500">‚Äî</div>'; }
}

// Restaurer les donn√©es si dispo
const saved = localStorage.getItem("octocash-data");
if (saved) {
  const inv = new Map(Object.entries(JSON.parse(saved)).map(([k,v]) => [Number(k), v]));

  rows.forEach(r => {
    const entry = inv.get(r.valueCents);
    if (entry) {
      // Remplir les champs
      const input = document.querySelector(`input[data-key="${r.key}"][data-type="loose"]`);
      if (input) input.value = entry.loose || "";

      if (r.hasRoll) {
        const select = document.querySelector(`select[data-key="${r.key}"][data-type="rolls"]`);
        if (select) select.value = entry.rolls || "0";
      }
    }
  });
}
    // --- Interactions UI ---
    function refreshTotals(){
  const inv = getInputCounts();
  computeTotals(inv);

  // Sauvegarde dans localStorage
  localStorage.setItem("octocash-data", JSON.stringify(Object.fromEntries(inv)));
}

    // Recalcul en live
    tbody.addEventListener('input', refreshTotals);
    tbody.addEventListener('change', refreshTotals);

    // Boutons "+" pour ajouter au vrac
tbody.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-plus]');
  if (!btn) return;

  const key = btn.dataset.plus;
  const input = document.querySelector(`input[data-key="${key}"][data-type="loose"]`);
  if (!input) return;

  // Focus (ouvre le clavier num√©rique sur mobile)
  input.focus();

  // Optionnel: place le curseur √† la fin de la valeur existante
  const val = input.value;
  input.value = '';
  input.value = val;
});


    // --- Modale fond ---
    const modal = document.getElementById('fondModal');
    const radios = () => Array.from(document.querySelectorAll('input[name="fondChoice"]'));
    function openModal(){
      const toSelect = state.lastFondChoice;
      radios().forEach(r=>{ r.checked = (r.value===toSelect); });
      const customInput = document.getElementById('fondCustom');
      if (customInput) customInput.value = '';
      document.getElementById('fondCustomHint').classList.add('hidden');
      modal.classList.remove('hidden');
      document.body.classList.add('modal-open');
    }
    function closeModal(){
      modal.classList.add('hidden');
      document.body.classList.remove('modal-open');
    }

    modal.addEventListener('click', (e)=>{
      if (e.target.dataset.close === 'backdrop') closeModal();
    });
    document.getElementById('fondCancel').addEventListener('click', closeModal);

    document.getElementById('fondCustom').addEventListener('input', ()=>{
      const customRadio = radios().find(r=>r.value==='custom');
      if (customRadio) customRadio.checked = true;
    });

    document.getElementById('fondConfirm').addEventListener('click', ()=>{
      const choice = radios().find(r=>r.checked);
      if (!choice) return;
      let fond = state.fondCible;
      if (choice.value === 'custom'){
        const valStr = document.getElementById('fondCustom').value.trim();
        const num = Number(valStr.replace(',', '.'));
        if (isNaN(num) || num < 0){
          document.getElementById('fondCustomHint').classList.remove('hidden');
          return;
        }
        fond = Math.round(num * 100);
        state.lastFondChoice = 'custom';
      } else {
        fond = Number(choice.value);
        state.lastFondChoice = choice.value;
      }
      state.fondCible = fond;
      closeModal();
      runCalculation();
    });

    // Bouton Calculer -> ouvre la modale
    document.getElementById('btnCalculer').addEventListener('click', openModal);

    function runCalculation(){
      const inv = getInputCounts();
      const res = calcRecette(inv, state.fondCible);
      const resultSec = document.getElementById('resultats');
      document.getElementById('fondActuelBadge').textContent = centsToStr(state.fondCible);

      if (!res.ok){
        resultSec.hidden = false;
        document.getElementById('valRecette').textContent = res.message;
        document.getElementById('detailRecette').innerHTML = '';
        return;
      }
      document.getElementById('valRecette').textContent = centsToStr(res.recetteTotal);
      renderRecetteOrdered(document.getElementById('detailRecette'), res.recette);
      resultSec.hidden = false;
    }

    // R√©initialiser
    document.getElementById('btnReset').addEventListener('click', () => {
      document.querySelectorAll('#tbody input').forEach(i => i.value = '');
      document.querySelectorAll('#tbody select').forEach(s => s.value = '0');
      refreshTotals();
      document.getElementById('resultats').hidden = true;
    });

    // init
    refreshTotals();
  </script>
</body>
</html>
